---
i18n:
  en: "Deployment"
  fr: "Déploiement en production"
---

# Déploiement en production

## Compilation pour la production

### Méthode 1 : Exécutable autonome (recommandée)


#### Compilation du jeu

```bash
# Installation de PyInstaller
pip install pyinstaller

# Compilation en fichier unique
pyinstaller --onefile --windowed \
    --add-data "assets:assets" \
    --name "GaladIslands" \
    main.py

# L'exécutable se trouve dans dist/GaladIslands
# Penser à copier les dossiers d'assets nécessaires
```

#### Compilation de l'outil de configuration

```bash
pyinstaller --onefile --windowed \
    --add-data "assets:assets" \
    --add-data "assets/locales:assets/locales" \
    --name "GaladConfigTool" \
    src/tools/galad_config_tool.py


### Méthode 2 : Distribution Python

```bash
# Préparer l'environnement
python3 -m venv venv_prod
source venv_prod/bin/activate
pip install -r requirements.txt

# Créer un script de lancement
cat > start_game.sh << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
./venv_prod/bin/python main.py
EOF
chmod +x start_game.sh
```

## Structure du package de production

```txt
galad-islands-<OS>/              # exemple: galad-islands-Linux/
├── galad-islands                # Exécutable jeu (Linux/macOS) — Windows: `galad-islands.exe`
├── galad-config-tool            # Outil de configuration — Windows: `galad-config-tool.exe`
├── MaraudeurAiCleaner           # Outil de nettoyage IA — Windows: `MaraudeurAiCleaner.exe`
├── _internal/                   # Bibliothèques natives unifiées partagées par les exécutables
├── README.md                    # Instructions d'installation et de packaging
└── galad_config.json            # Configuration (créé automatiquement si absent)
```

## Instructions de déploiement

### Pour les utilisateurs finaux

1. **Télécharger** le package complet
2. **Extraire** dans un dossier
3. **Lancer** l'exécutable `GaladIslands`

## Refactor du système de build et release (technique)

Le système de build et de release a été refactoré pour être plus cohérent et résilient sur l'ensemble des plateformes et dans CI.

 
### Objectifs

- Produire des builds `onedir` reproductibles pour tous les exécutables et regrouper ces builds dans une archive ZIP unique.
- Dédupliquer `assets` et `models` entre les différentes sorties `onedir` pour réduire la taille des releases.
- Ajouter un cache fiable dans GitHub Actions afin que les builds suivants réutilisent les paquets pip et le cache PyInstaller.
- Corriger les problèmes spécifiques à Windows autour de PowerShell (`Test-Path`) et de l'échappement des chemins.
- Utiliser une clé stable pour le cache pip basée sur `requirements.lock` si disponible.

 
### Changements (haut niveau)

- `build.spec` a été créé pour construire tous les exécutables en tant que sorties `onedir` en une seule exécution de PyInstaller.
- Les workflows GitHub Actions (`.github/workflows/test-build.yml`, `manual-release.yml`, `release.yml`) partagent désormais le même bloc de build :
  - Détection du répertoire de cache pip par OS (Linux/macOS vs Windows) et exposition en tant que sortie d'étape.
  - Calcul de la clé pip via SHA-256 de `requirements.lock` si présent, sinon `requirements.txt`.
  - Cache des dépendances pip et du dossier de build PyInstaller (`build/`) via `actions/cache`.
  - Exécution `pyinstaller build.spec` pour produire les builds onedir.
- Scripts de packaging disponibles dans `tools/` :
  - `tools/package_release.sh` — script Bash (Linux/macOS) pour combiner les onedir en un unique ZIP et dédupliquer `assets/` et `models/`.
  - `tools/package_release.ps1` — script PowerShell pour Windows avec la même logique de déduplication.

 
### Détails du packaging

- L'archive `galad-islands-<OS>.zip` produite contient :
  - Les exécutables en racine : `galad-islands`, `galad-config-tool`, `MaraudeurAiCleaner` (suffixe Windows `.exe` selon l'OS).
  - `_internal/` unifié : toutes les bibliothèques natives partagées sont dans un unique dossier `_internal/`.
  - Les collisions d'exécutables sont traitées par renommage temporaire pendant le packaging.

 
### CI & stabilité du cache

- La pipeline calcule une clé stable pour `actions/cache` en prenant le SHA256 de `requirements.lock` si présent ; ainsi la clé ne change pas à chaque run sans changement de dépendances.
- En l'absence de `requirements.lock`, on réalise le fallback sur `requirements.txt`.
- Le dossier de build PyInstaller (`build/`) est aussi mis en cache via `hashFiles('build.spec', 'main.py', ...)` afin de réutiliser l'analyse précédente de PyInstaller.

 
### Corrections Windows

- Le traitement des chemins PowerShell a été renforcé : `Test-Path -LiteralPath` est utilisé pour éviter les erreurs liées aux backslashes ou aux variables développées dans des chaînes.
 
### Lancer le packaging localement (Linux/macOS)

1. Produire l'output onedir pour tous les exécutables :

```bash
pyinstaller build.spec
```

1. Lancer le script de packaging pour votre OS (exemple : Linux) :

```bash
bash tools/package_release.sh Linux
# produit galad-islands-Linux.zip à la racine du repo
```

1. Inspectez l'archive produite pour vérifier la déduplication des assets et modèles ainsi que l'unification de `_internal/`.

 
### Tester le cache CI localement

- Créez un `requirements.lock` (ex. via `pip-compile`) et poussez la branche ; regardez les logs du job `test-build` :
  - Cherchez `Cache hit occurred` pour `actions/cache` (pip et PyInstaller) lors des runs suivants.
